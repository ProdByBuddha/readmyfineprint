Error tracking usage: DrizzleQueryError: Failed query: insert into "usage_records" ("id", "user_id", "subscription_id", "period", "documents_analyzed", "tokens_used", "cost", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, $5, $6, $7) returning "id", "user_id", "subscription_id", "period", "documents_analyzed", "tokens_used", "cost", "created_at", "updated_at"
params: 3dbba68a4388247dcb9f49aa52f30829,2025-06,1,1010,0.000909,2025-06-22T20:59:34.466Z,2025-06-22T20:59:34.466Z
    at NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:74:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
    ... 4 lines matching cause stack trace ...
    at async PriorityProcessingQueue.processRequest (/home/runner/workspace/server/priority-queue.ts:120:22) {
  query: 'insert into "usage_records" ("id", "user_id", "subscription_id", "period", "documents_analyzed", "tokens_used", "cost", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, $5, $6, $7) returning "id", "user_id", "subscription_id", "period", "documents_analyzed", "tokens_used", "cost", "created_at", "updated_at"',
  params: [
    '3dbba68a4388247dcb9f49aa52f30829',
    '2025-06',
    1,
    1010,
    '0.000909',
    '2025-06-22T20:59:34.466Z',
    '2025-06-22T20:59:34.466Z'
  ],
  cause: error: insert or update on table "usage_records" violates foreign key constraint "usage_records_user_id_fkey"
      at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1087:33
      at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
      at async <anonymous> (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:153:11)
      at async NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:72:12)
      at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
      at async DatabaseStorage.createUsageRecord (/home/runner/workspace/server/database-storage.ts:183:21)
      at async SubscriptionService.trackUsage (/home/runner/workspace/server/subscription-service.ts:605:9)
      at async analyzeDocument (/home/runner/workspace/server/openai.ts:80:7)
      at async Object.processFunction (/home/runner/workspace/server/routes.ts:386:18)
      at async PriorityProcessingQueue.processRequest (/home/runner/workspace/server/priority-queue.ts:120:22) {
    length: 309,
    severity: 'ERROR',
    code: '23503',
    detail: 'Key (user_id)=(3dbba68a-4388-247d-cb9f-49aa52f30829) is not present in table "users".',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'usage_records',
    column: undefined,
    dataType: undefined,
    constraint: 'usage_records_user_id_fkey',
    file: 'ri_triggers.c',
    line: '2608',
    routine: 'ri_ReportViolation'
  }
}