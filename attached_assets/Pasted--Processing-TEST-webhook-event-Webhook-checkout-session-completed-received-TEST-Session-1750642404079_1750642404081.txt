ğŸ“ Processing TEST webhook event
ğŸ“ Webhook checkout.session.completed received (TEST):
   Session ID: cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY
   Mode: subscription
   Payment Status: paid
   Subscription ID: sub_1RczFKPxX1dXZoQGYGjjDBtP
   Customer ID: cus_SY5Qisc2iM8hVj
   Metadata: {
  tierId: 'starter',
  billingCycle: 'yearly',
  userId: 'bf3a6c837b57c4b92ecf0f6ec254e729'
}
ğŸ‰ Processing subscription checkout (TEST): cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY
ğŸ“‹ Extracted data: tierId=starter, userId=bf3a6c837b57c4b92ecf0f6ec254e729, customerId=cus_SY5Qisc2iM8hVj, subscriptionId=sub_1RczFKPxX1dXZoQGYGjjDBtP
ğŸš€ Starting subscription creation process...
ğŸ‘¤ User bf3a6c837b57c4b92ecf0f6ec254e729 not found in database, creating subscription user
ğŸ“§ Using customer email for missing user: beatsbybuddha@gmail.com
Error creating subscription user: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"
params: beatsbybuddha@gmail.com,subscriber_c2iM8hVj,4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6,2025-06-23T01:32:32.754Z,2025-06-23T01:32:32.754Z
    at NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:74:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
    ... 2 lines matching cause stack trace ...
    at async <anonymous> (/home/runner/workspace/server/routes.ts:1480:36) {
  query: 'insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"',
  params: [
    'beatsbybuddha@gmail.com',
    'subscriber_c2iM8hVj',
    '4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6',
    '2025-06-23T01:32:32.754Z',
    '2025-06-23T01:32:32.754Z'
  ],
  cause: error: duplicate key value violates unique constraint "users_email_key"
      at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1087:33
      at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
      at async <anonymous> (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:153:11)
      at async NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:72:12)
      at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
      at async DatabaseStorage.createUser (/home/runner/workspace/server/database-storage.ts:96:20)
      at async SubscriptionService.createSubscriptionUser (/home/runner/workspace/server/subscription-service.ts:991:20)
      at async <anonymous> (/home/runner/workspace/server/routes.ts:1480:36) {
    length: 215,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key (email)=(beatsbybuddha@gmail.com) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_email_key',
    file: 'nbtinsert.c',
    line: '666',
    routine: '_bt_check_unique'
  }
}
âŒ Error processing subscription checkout: DrizzleQueryError: Failed query: insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"
params: beatsbybuddha@gmail.com,subscriber_c2iM8hVj,4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6,2025-06-23T01:32:32.754Z,2025-06-23T01:32:32.754Z
    at NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:74:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
    ... 2 lines matching cause stack trace ...
    at async <anonymous> (/home/runner/workspace/server/routes.ts:1480:36) {
  query: 'insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"',
  params: [
    'beatsbybuddha@gmail.com',
    'subscriber_c2iM8hVj',
    '4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6',
    '2025-06-23T01:32:32.754Z',
    '2025-06-23T01:32:32.754Z'
  ],
  cause: error: duplicate key value violates unique constraint "users_email_key"
      at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1087:33
      at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
      at async <anonymous> (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:153:11)
      at async NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:72:12)
      at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
      at async DatabaseStorage.createUser (/home/runner/workspace/server/database-storage.ts:96:20)
      at async SubscriptionService.createSubscriptionUser (/home/runner/workspace/server/subscription-service.ts:991:20)
      at async <anonymous> (/home/runner/workspace/server/routes.ts:1480:36) {
    length: 215,
    severity: 'ERROR',
    code: '23505',
    detail: 'Key (email)=(beatsbybuddha@gmail.com) already exists.',
    hint: undefined,
    position: undefined,
    internalPosition: undefined,
    internalQuery: undefined,
    where: undefined,
    schema: 'public',
    table: 'users',
    column: undefined,
    dataType: undefined,
    constraint: 'users_email_key',
    file: 'nbtinsert.c',
    line: '666',
    routine: '_bt_check_unique'
  }
}
   Session ID: cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY
   Error details: Failed query: insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"
params: beatsbybuddha@gmail.com,subscriber_c2iM8hVj,4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6,2025-06-23T01:32:32.754Z,2025-06-23T01:32:32.754Z
   Stack trace: Error: Failed query: insert into "users" ("id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at") values (default, $1, $2, $3, default, $4, $5) returning "id", "email", "username", "hashed_password", "stripe_customer_id", "created_at", "updated_at"
params: beatsbybuddha@gmail.com,subscriber_c2iM8hVj,4572b1f384b54cbed69d5e56a6f314a728313206ca7c59cc28a30e69e9b1dce6,2025-06-23T01:32:32.754Z,2025-06-23T01:32:32.754Z
    at NeonPreparedQuery.queryWithCache (/home/runner/workspace/node_modules/src/pg-core/session.ts:74:11)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:152:18)
    at async DatabaseStorage.createUser (/home/runner/workspace/server/database-storage.ts:96:20)
    at async SubscriptionService.createSubscriptionUser (/home/runner/workspace/server/subscription-service.ts:991:20)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:1480:36)
1:32:32 AM [express] POST /api/stripe-webhook 200 in 423ms :: {"received":true}
â„¹ï¸ [SECURITY] SESSION_MANAGEMENT | LOW | 079f9cf6 | New session created
ğŸ“ New session logged for client: 98a4569bac473d3838454b8d0975566a
ğŸ”‡ Session logging suppressed for client (cooldown: 153ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 230ms)
â„¹ï¸ [SECURITY] SESSION_MANAGEMENT | LOW | 02c43f44 | New session created
ğŸ“ New session logged for client: 2bf5c1bb834d2f6de07ace54d190891a
ğŸ”‡ Session logging suppressed for client (cooldown: 5ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 66ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 68ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 180ms)
â„¹ï¸ [SECURITY] SESSION_MANAGEMENT | LOW | dca67e37 | New session created
ğŸ“ New session logged for client: 4c0653fb448fcb38294523e89bb180bb
ğŸ”‡ Session logging suppressed for client (cooldown: 419ms)
â„¹ï¸ [SECURITY] SESSION_MANAGEMENT | LOW | 7e3ab120 | New session created
ğŸ“ New session logged for client: 45a239c03c1a4f32fe61b672ed200f37
ğŸ”‡ Session logging suppressed for client (cooldown: 193ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 221ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 237ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 52ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 471ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 51ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 272ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 288ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 100ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 520ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 103ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 301ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 317ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 333ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 571ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 152ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 345ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 159ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 365ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 391ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 392ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 623ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 204ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 210ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 406ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 440ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 672ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 447ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 261ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 259ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 454ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 488ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 720ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 498ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 314ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 317ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 505ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 534ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 771ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 544ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 367ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 556ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 372ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 582ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 588ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 820ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 607ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 421ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 420ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 639ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 640ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 872ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 653ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 467ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 469ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 689ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 689ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 926ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 1187ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 1252ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 1535ms)
ğŸ”‡ Session logging suppressed for client (cooldown: 4152ms)
ğŸ” Token retrieval request for session: cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY
Replit DB get result for session_token:cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY: {
  ok: false,
  error: { message: 'invalid token', statusCode: 403 },
  errorExtras: undefined
}
Replit DB returned error for session cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY: { message: 'invalid token', statusCode: 403 }
ğŸ”‘ Token lookup result: not found
âŒ No token found for session: cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEonxhNGtMHod22CiY
ğŸ’³ Found paid Stripe session but no token - webhook may not have processed yet
1:32:38 AM [express] GET /api/subscription/token/cs_test_a1R9ZFmJ0xyGQ3wUyuofDYbiVXNrNcE6cc0ulQv7cEoâ€¦